<link rel="stylesheet" href="../style.css?v=1">

<button id="copy">copy</button>
<form>
  <input class="km" type="number" value="">

  <p id="ff">
    <select name="kmID[]" id="taxID">
      <option value="">--税種選択--</option>
      <option value="0"> 内税 </option>
      <option value="1"> 源泉徴収差引 </option>
      <option value="2"> 消費税 </option>
    </select>

    <br><label class="label">税額</label> <input class="input" name="kmTanka[]" type="text" id="taxTanka"> 
    <br><label class="label">税抜合計</label> <input class="input" type="text" id="shoke" name="shoke">
    <br><label class="label">合計</label> <input class="input" type="text" id="goke" name="goke">
  </p>
  
  <p><button type="submit" class="button is-info" id="addRow"> 確認 </button></p>
</form>



<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script>
  
  // 要素をコピー
  $('#copy').click(function(){
    var textBox = $('form .km').prop('outerHTML');
    $('#ff').before(textBox);
  });


  $('#taxID').change(function(){
    var total = 0;
        //全部のtextBoxの値を取得
      $('.km').each(function(i,e){
        if( $(e).val() != "" )
          total += parseInt($(e).val()) ; //文字列→数値にキャスト
      });

      switch ($(this).val()) {
        case "0": //内税 
          //小数発生時には消費税切り捨て､小計は合計から引き算し一致させる
          var tax = Math.floor( total / 11 );
          var shoke = total - tax 
          $('#taxTanka').val(tax);
          $('#shoke').val(shoke);
          $('#goke').val(total);
          break;
          
          case "1": //源泉徴収差引
          var gtax = Math.floor(total * 0.1);
          $('#taxTanka').val(gtax);
          $('#shoke').val(total);
          $('#goke').val(total - gtax);
          break;

        case "2": //消費税
        var tax = Math.floor(total * 0.1);
          $('#taxTanka').val(tax);
          $('#shoke').val(total);
          $('#goke').val(total + tax);
          break;
      }  
  });
</script>
g / 1.1 / 10 = tax 
g / 11 = tax

